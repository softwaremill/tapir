# 11. Dedicated schema macros

Date: 2022-05-16

## Context

We've been considering replacing the Magnolia-base derivation with custom `Schema` macros for three main reasons:

1. allow additional compile-time validation, such as whether validators are added properly (https://github.com/softwaremill/tapir/issues/2110)
2. provide better Schema-dedicated error reports, to improve debuggability of schema derivation
3. potentially (not verified) speed up the compilation process (as we directly generate the schemas at compile-time, without the intermediary Magnolia representation and proper derivation happening at run-time)
4. potentially (not verified) decrease the size of generated code (as we only need a fraction of the meta-data that is generated by Magnolia)

Switching the way schemas are derived would need to be done before 1.0, as generating code without a Magnolia dependency would break backwards compatibility.

## Decision

Two PoCs have been implemented, one for Scala2, and one for Scala3, on the following branches:

* https://github.com/softwaremill/tapir/tree/scala2-schema-experiment (Scala2)
* https://github.com/softwaremill/tapir/tree/schema-experiments (Scala3)

However, the Scala2 version would require re-implementing (or copying) large parts of Magnolia to handle recursive derivation in both auto and semi-auto modes. Because of little verified benefit, the experiment was put on hold.

The Scala3 version got stuck due to compiler bugs (https://github.com/lampepfl/dotty/discussions/15157, https://github.com/lampepfl/dotty/issues/15159), so possible future work is possible, when the above is fixed. We might initially release a backwards-compatible-guaranteed version only for Scala2, which would leave more room to improve the Scala3 variant.